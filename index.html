<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Greater Kuala Lumpur Urban Rail Map</title>

  <!-- Vega libraries -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <!-- topojson client is required to read TopoJSON in the browser -->
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 14px; }
    h2 { margin-bottom: 12px; }
    #vis { display: inline-block; }
    pre#dbg { text-align: left; max-width: 900px; margin: 12px auto; background: #f7f7f7; padding: 8px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
  </style>
</head>
<body>
  <h2>Greater Kuala Lumpur Urban Rail Network — 2025</h2>
  <div id="vis">Loading visualization...</div>
  <pre id="dbg" style="display:none"></pre>

<script type="text/javascript">
(async function(){
  const dbg = (s)=> {
    try {
      document.getElementById('dbg').style.display='block';
      document.getElementById('dbg').textContent += s + "\n";
    } catch(e){ console.log(s); }
  };

  // Quick connectivity checks: fetch each raw file to ensure it's reachable
  const rawBase = 'https://raw.githubusercontent.com/zhangkai427007/week9/main/';
  const files = ['states_provinces.json','route2.json','export.json'];
  for (const f of files) {
    try {
      dbg('FETCH START ' + f);
      const r = await fetch(rawBase + f, {cache: "no-store"});
      dbg('FETCH ' + f + ' status=' + r.status + ' content-type=' + (r.headers.get('content-type')||''));
      if (!r.ok) {
        dbg('ERROR: Failed to fetch ' + f + ' (HTTP ' + r.status + '). Check filename and branch.');
      } else {
        // read a tiny piece to detect HTML vs JSON
        const txt = await r.text();
        const preview = txt.slice(0,250).replace(/\n/g,' ');
        dbg('PREVIEW ' + f + ': ' + preview);
        if (preview.trim().startsWith('<')) dbg('ERROR: ' + f + ' appears to be HTML not JSON/TopoJSON.');
      }
    } catch(err) {
      dbg('EXCEPTION fetching ' + f + ': ' + err);
    }
  }

  // If checks pass (or even if not), construct spec and try to embed
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "title": {
      "text": "Greater Kuala Lumpur Klang Valley Urban Rail Network — 2025",
      "fontSize": 16,
      "subtitle": "Kuala Lumpur, Selangor, Putrajaya (Urban lines only)",
      "subtitleFontStyle": "italic"
    },
    "width": 650,
    "height": 600,
    "projection": {
      "type": "mercator",
      "center": [101.69, 3.13],
      "scale": 35000
    },
    "layer": [
      {
        "mark": {"type": "geoshape", "fill": "#cceeff"},
        "data": {"sphere": true}
      },
      {
        "data": {"graticule": {"step": [0.1, 0.1]}},
        "mark": {"type": "geoshape", "stroke": "#cccccc", "strokeWidth": 0.5}
      },
      {
        "data": {
          "url": rawBase + "states_provinces.json",
          "format": {"type": "topojson", "feature": "ne_10m_admin_1_states_provinces"}
        },
        "mark": {"type": "geoshape", "stroke": "gray", "strokeWidth": 0.5},
        "encoding": {"color": {"value": "#e7f0e7"}, "tooltip": {"field": "properties.name","title":"State/Region"}}
      },
      {
        "data": {
          "url": rawBase + "route2.json",
          "format": {"property": "features"}
        },
        "transform": [
          {"filter": "datum.properties.network != 'KTM ETS'"},
          {"filter": "datum.properties.network != 'KLIA Express'"},
          {"filter": "datum.properties.network != 'KLIA Transit'"},
          {"flatten": ["geometry.coordinates"]},
          {"calculate": "datum['geometry.coordinates'][0]", "as": "lon"},
          {"calculate": "datum['geometry.coordinates'][1]", "as": "lat"}
        ],
        "mark": {"type": "line", "strokeWidth": 2, "opacity": 0.9},
        "encoding": {
          "longitude": {"field": "lon", "type": "quantitative"},
          "latitude": {"field": "lat", "type": "quantitative"},
          "detail": {"field": "properties.name"},
          "color": {
            "field": "properties.network",
            "type": "nominal",
            "legend": {"title": "Urban Rail Network"},
            "scale": {"domain":["Rapid KL","MRT","KL Monorail","KTM Komuter"], "range":["#e0115f","#1f78b4","#69a74c","#003366"]}
          },
          "tooltip": {"field":"properties.name","title":"Line Name"}
        }
      },
      {
        "data": {
          "url": rawBase + "export.json",
          "format": {"property": "features"}
        },
        "transform": [
          {"filter":"datum.properties.network != 'KTM ETS'"},
          {"filter":"datum.properties.network != 'KLIA Express'"},
          {"filter":"datum.properties.network != 'KLIA Transit'"}
        ],
        "mark": {"type":"circle","opacity":0.85,"size":25},
        "encoding": {
          "longitude":{"field":"geometry.coordinates[0]","type":"quantitative"},
          "latitude":{"field":"geometry.coordinates[1]","type":"quantitative"},
          "tooltip":[{"field":"properties.name","title":"Station Name"},{"field":"properties.network","title":"Network"}],
          "color":{"field":"properties.network","type":"nominal","legend":{"title":"Urban Rail Network"},
                   "scale":{"domain":["Rapid KL","MRT","KL Monorail","KTM Komuter"], "range":["#e0115f","#1f78b4","#69a74c","#003366"]}}
        }
      }
    ],
    "config": {"view":{"stroke":"transparent"}, "background":"#ADD8E6"}
  };

  // show in console we're attempting to embed
  dbg('Attempting to embed spec...');
  try {
    const res = await vegaEmbed('#vis', spec, {renderer: "svg"});
    dbg('vegaEmbed succeeded.');
  } catch(err) {
    dbg('vegaEmbed ERROR: ' + (err && err.message ? err.message : String(err)));
    console.error(err);
    document.getElementById('vis').innerText = 'Failed to load visualization. See console for details.';
  }

})();
</script>
</body>
</html>

